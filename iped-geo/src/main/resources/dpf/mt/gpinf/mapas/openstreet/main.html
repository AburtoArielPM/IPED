<html> 
    <head>
		
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
				
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
		
		<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin=""></script>
		<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" crossorigin=""></script>
		<script>
		{{markerclusterjs}}
		</script>

		<style type="text/css">
		#map_canvas { height:800px; }
		.circle_class{
			border: 2px dotted #38f;
			background: rgba(255,255,255,0.5);
			border-radius: 50%;
			width: 0;
			height: 0;
			-moz-box-sizing: border-box;
	     		box-sizing: border-box;
			z-index: 800;
		}
		.leaflet-popup{
			opacity: 0.8;
		}
		.rect_class{
			border-radius: 0%;
		}
		.kml-popup{
			background: rgba(255,255,255,0.7);
		}
		body { margin:0px;padding:0px }
		</style>

        <script type="text/javascript">
		{{L.KML}}
		</script>

    <script>
    var map;
    var track;
    
    function initialize() {
        var kmlUrl = '';
        
        map = new L.IPEDMap('map_canvas', { center: new L.LatLng(58.4, 43.0), zoom: 11, boxZoom:true , inertia:true });

		L.tileLayer('{{tileServerUrl}}', {
    			maxZoom: 18,
    			tileSize: 512,
    			zoomOffset: -1,
				}).addTo(map);
		
		var img = L.DomUtil.create('img');
		img.src = '{{layers_img}}';
		L.DomEvent.on(img, 'click', changeTileServer);

		L.control.tilesSrcSelect(img, { position: 'topleft' }).addTo(map);

         const parser = new DOMParser();
         const kml = parser.parseFromString('{{kml}}', 'text/xml');
         track = new L.KML(kml);
         map.addLayer(track);

		document.getElementById('ordem_descr').innerHTML = track.tourOrder;
		document.getElementById('resultsinfo').innerHTML = 'Mapped Items:'+track.markersCount(); 

		const bounds = track.getBounds();
		map.fitBounds(bounds);
    }
    
    function changeTileServer(e){
    	if(e.isTrusted){
    		window.app.getMap().fireChangeTileServer();
   		}
	}

	mpos=0;
    function navega(pos){
    	if(pos<0){
    		alert('The navigation already is on the first item.');
    	}
    	if(pos>=track.markersCount()){
    		alert('The navigation already is on the last item.')
    	}

		var i=0;
       	for (var ind in track.markers){
    		if(i==pos){
    			window.app.markerMouseClickedBF(ind,1,'');
    			track.centralizaMarcadores([track.markers[ind]]);
    			mpos=i;
    			break;
    		}
       		i++;
       	}
    	return false;
    }
    
    function toogleVisibility(){
    	if(document.getElementById("barra_content").style.display == "none"){
        	document.getElementById("td_barra").style.width="50px";
        	document.getElementById("barra_content").style.display = "block";
        	document.getElementById("toogleVisibilityButton").innerHTML = "-";
    	}else{
        	document.getElementById("td_barra").style.width="10px";
        	document.getElementById("barra_content").style.display = "none";
        	document.getElementById("toogleVisibilityButton").innerHTML = "+";
    	}
    }
    
	</script>
    </head>
    
    
    <body onload="initialize();">
       <table style="height:100%;width:100%"><tr>
       <td width="*">
  			<div id="map_canvas" style="width:100%;height:100%;"></div>
  		</td>
    <td width="50px" id="td_barra">
   <div id="barra_lateral" style="height:100%;width:100%;">
   		<a href="#" onclick="toogleVisibility();" id="toogleVisibilityButton">-</a>
   		<div id="barra_content" style="width:100%; border:0px;">
   	 		<div id="resultsinfo" style="width:100px"></div>
   	 		<div style="background-color:#666666; color:white; border:1px solid #000000;">Selection:</div>
   			<input type="button" name="selecaoRetangular" value="Area" onclick="map.activateAreaDrag();" style="width:100%"/>
   			<input type="button" name="selecaoRaio" value="Radius" onclick="map.activateRadiusDrag();" style="width:100%"/>
   	 		<div style="background-color:#666666; color:white; border:1px solid #000000;">Sorting:</div>
   	 		<div style="width:100px; font-size:80%; min-height:20px" id="ordem_descr"></div>
   	 		<div style="background-color:#666666; color:white; border:1px solid #000000;">Navigation:</div>
   			<input type="button" name="primeiro" value="First" onclick="navega(0);" style="width:100%"/>
   			<input type="button" name="anterior" value="Previous" onclick="navega(mpos-1);" style="width:100%"/>
   			<input type="button" name="proximo" value="Next" onclick="navega(mpos+1);" style="width:100%"/>
   			<input type="button" name="ultimo" value="Last" onclick="navega(track.markersCount()-1);" style="width:100%"/>
   	 		<br/><br/>
   			<input type="button" name="zoomout" value="Display All" onclick="track.viewAll();" style="width:100%"/>
   			<input type="button" name="export" value="Export KML" onclick="exportarKml();" style="width:100%"/>


			<div style="position:absolute; bottom:20px; border:1px;" id="distancia_calc"></div>
		</div>
   </div>
   </td></tr>
</table>
    </body>
    <div id="the_side_bar" style="position:fixed;float:right;height:100%;width:100%; visibility:hidden"></div>    
</html>